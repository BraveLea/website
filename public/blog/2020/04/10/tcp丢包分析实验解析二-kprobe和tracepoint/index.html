<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>“tcp丢包分析”实验解析(二)&amp;ndash;kprobe和tracepoint</title>
  <meta name="author" content="DevCows" />
  
  
  
  
  <meta name="keywords" content="devows, hugo, go">
  
  
  <meta name="description" content="tcp丢包分析系列文章代码来自谢宝友老师，由西邮陈莉君教授研一学生进行解析，本文由戴君毅整理，梁金荣编辑，贺东升校对。">

  <meta name="generator" content="Hugo 0.68.3" />

  
  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.11.2/css/all.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  
  <link href="/css/animate.css" rel="stylesheet">

  
  
    <link href="/css/style.default.css" rel="stylesheet" id="theme-stylesheet">
  

  
  <link href="/css/custom.css" rel="stylesheet">

  
  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png" />

  
  <link href="/css/owl.carousel.css" rel="stylesheet">
  <link href="/css/owl.theme.css" rel="stylesheet">

  
  <link rel="alternate" href="https://example.org/index.xml" type="application/rss+xml" title="Linux内核之旅">

  
  
  
  
  
  
  
  <meta property="og:locale" content="en_us">
  <meta property="og:site_name" content="Linux内核之旅">
  <meta property="og:title" content="“tcp丢包分析”实验解析(二)&amp;ndash;kprobe和tracepoint">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://example.org/blog/2020/04/10/tcp%E4%B8%A2%E5%8C%85%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%E8%A7%A3%E6%9E%90%E4%BA%8C-kprobe%E5%92%8Ctracepoint/" />
  <meta property="og:description" content="tcp丢包分析系列文章代码来自谢宝友老师，由西邮陈莉君教授研一学生进行解析，本文由戴君毅整理，梁金荣编辑，贺东升校对。">
  <meta property="og:image" content="https://example.org/img/banners/%E2%80%9Ctcp%E4%B8%A2%E5%8C%85%E5%88%86%E6%9E%90%E2%80%9D%E5%AE%9E%E9%AA%8C%E8%A7%A3%E6%9E%90%28%E4%BA%8C%29.png">
  <meta property="og:image:type" content="image/png">
  
  
  
    <meta property="og:image:width" content="709">
    <meta property="og:image:height" content="474">
  
  
  <meta property="og:updated_time" content="2020-04-10T00:00:00Z">
  
    
    
    <meta property="article:section" content="Linux内核试验">
    
    
    <meta property="article:published_time" content="2020-04-10T00:00:00Z">
    <meta property="article:modified_time" content="2020-04-10T00:00:00Z">
  

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@GoHugoIO">
  <meta name="twitter:title" content="“tcp丢包分析”实验解析(二)&amp;ndash;kprobe和tracepoint">
  
  <meta name="twitter:image" content="https://example.org/img/banners/%E2%80%9Ctcp%E4%B8%A2%E5%8C%85%E5%88%86%E6%9E%90%E2%80%9D%E5%AE%9E%E9%AA%8C%E8%A7%A3%E6%9E%90%28%E4%BA%8C%29.png">
  
  <meta name="twitter:description" content="tcp丢包分析系列文章代码来自谢宝友老师，由西邮陈莉君教授研一学生进行解析，本文由戴君毅整理，梁金荣编辑，贺东升校对。">
  

</head>


  <body>

    <div id="all">

        <header>

          <div class="navbar-affixed-top" data-spy="affix" data-offset-top="200">

    <div class="navbar navbar-default yamm" role="navigation" id="navbar">

        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="/">
                    <img src="/img/Linux内核之旅-logo.png" alt="Linux内核之旅-logo" class="hidden-xs hidden-sm">
                    <img src="/img/Linux内核之旅-logo.png" alt="Linux内核之旅-logo" class="visible-xs visible-sm">
                    <span class="sr-only">“tcp丢包分析”实验解析(二)--kprobe和tracepoint - 跳到主页</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">切换导航</span>
                        <i class="fas fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  
                  
                  
                  <li class="dropdown">
                    
                    <a href="/">主页</a>
                    
                  </li>
                  
                  
                  <li class="dropdown active">
                    
                    <a href="/blog/">博客</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="https://github.com/linuxkerneltravel/LearningLinux">github</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="https://next.xuetangx.com/course/XIYOU08091001441/1516763">mooc</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="/contact/">关于</a>
                    
                  </li>
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">

                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">

                    <button type="submit" class="btn btn-template-main"><i class="fas fa-search"></i></button>

                </span>
                    </div>
                </form>

            </div>
            

        </div>
    </div>
    

</div>




        </header>

        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>“tcp丢包分析”实验解析(二)--kprobe和tracepoint</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            <div class="container">

                <div class="row">

                    

                    <div class="col-md-9" id="blog-post">

                        
                          <p class="text-muted text-uppercase mb-small text-right">
                            
                            
                            10100-00&#43;00
                          </p>
                        

                        <div id="post-content">
                          <blockquote>
<p>tcp丢包分析系列文章代码来自谢宝友老师，由西邮陈莉君教授研一学生进行解析，本文由戴君毅整理，梁金荣编辑，贺东升校对。</p>
</blockquote>
<p>继续顺下实验代码，前面说过，我们需要为我们（在proc文件系统中）加入的条目编写操作集接口：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> file_operations drop_packet_fops <span style="color:#f92672">=</span> {
	.open           <span style="color:#f92672">=</span> drop_packet_open,
	.read           <span style="color:#f92672">=</span> seq_read,
	.llseek         <span style="color:#f92672">=</span> seq_lseek,
	.write          <span style="color:#f92672">=</span> drop_packet_write,
	.release        <span style="color:#f92672">=</span> single_release,
};
</code></pre></div><p>实验的运行逻辑重点落在了write操作的实现中：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> ssize_t <span style="color:#a6e22e">drop_packet_write</span>(<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>file,
	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> __user <span style="color:#f92672">*</span>buf, size_t count, loff_t <span style="color:#f92672">*</span>offs)
{
	<span style="color:#66d9ef">int</span> ret;
	<span style="color:#66d9ef">char</span> cmd[<span style="color:#ae81ff">255</span>];
	<span style="color:#66d9ef">char</span> chr[<span style="color:#ae81ff">255</span>];

	<span style="color:#66d9ef">if</span> (count <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#f92672">*</span>offs)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;

	<span style="color:#66d9ef">if</span> (copy_from_user(chr, buf, <span style="color:#ae81ff">255</span>))
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EFAULT;

	ret <span style="color:#f92672">=</span> sscanf(chr, <span style="color:#e6db74">&#34;%255s&#34;</span>, cmd);
	<span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;

	<span style="color:#66d9ef">if</span> (strcmp(cmd, <span style="color:#e6db74">&#34;activate&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>drop_packet_activated)
			drop_packet_activated <span style="color:#f92672">=</span> activate_drop_packet();
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (strcmp(cmd, <span style="color:#e6db74">&#34;deactivate&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
		<span style="color:#66d9ef">if</span> (drop_packet_activated)
			deactivate_drop_packet();
		drop_packet_activated <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
	}

	<span style="color:#66d9ef">return</span> count;
}
</code></pre></div><p>它的逻辑很简单，我们把用户写入的字符串通过<code>copy_from_user</code>传入到内核<code>buf</code>中，然后调用<code>sscanf</code>格式化<code>buf</code>为<code>cmd</code>，然后跟“activate”和“deactiavate”比较，换句话说，如果用户输入“activate”，那么就可以开启丢包检测了。在加载模块后，用如下命令可以查看proc内容，由<code>drop_packet_show</code>实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">drop_packet_show</span>(<span style="color:#66d9ef">struct</span> seq_file <span style="color:#f92672">*</span>m, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v)
{
	seq_printf(m, <span style="color:#e6db74">&#34;settings:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
	seq_printf(m, <span style="color:#e6db74">&#34;  activated: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, drop_packet_activated <span style="color:#f92672">?</span> <span style="color:#e6db74">&#34;y&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;N&#34;</span>);

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p><strong>cat /proc/mooc/net/drop-packet</strong></p>
<p>结果如下：（省略了settings:）</p>
<p><code>activated: N</code></p>
<p>执行如下命令，可以激活丢包检测功能：</p>
<p><strong>echo activate &gt; /proc/mooc/net/drop-packet</strong></p>
<p>再次查看proc文件内容，结果如下：</p>
<p><code>activated: y</code></p>
<p>那么接下来自然要看下<code>activate_drop_packet</code>干了些什么事：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">activate_drop_packet</span>(<span style="color:#66d9ef">void</span>)
{
	hook_tracepoint(<span style="color:#e6db74">&#34;net_dev_xmit&#34;</span>, trace_net_dev_xmit_hit, NULL);
	hook_kprobe(<span style="color:#f92672">&amp;</span>kprobe_dev_queue_xmit, <span style="color:#e6db74">&#34;dev_queue_xmit&#34;</span>,
				kprobe_dev_queue_xmit_pre, NULL);
	hook_kprobe(<span style="color:#f92672">&amp;</span>kprobe_eth_type_trans, <span style="color:#e6db74">&#34;eth_type_trans&#34;</span>,
				kprobe_eth_type_trans_pre, NULL);
	hook_kprobe(<span style="color:#f92672">&amp;</span>kprobe_napi_gro_receive, <span style="color:#e6db74">&#34;napi_gro_receive&#34;</span>,
				kprobe_napi_gro_receive_pre, NULL);
	hook_kprobe(<span style="color:#f92672">&amp;</span>kprobe___netif_receive_skb_core, <span style="color:#e6db74">&#34;__netif_receive_skb_core&#34;</span>,
				kprobe___netif_receive_skb_core_pre, NULL);
	hook_kprobe(<span style="color:#f92672">&amp;</span>kprobe_tcp_v4_rcv, <span style="color:#e6db74">&#34;tcp_v4_rcv&#34;</span>,
				kprobe_tcp_v4_rcv_pre, NULL);

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>可以看到，这段代码在<code>net_dev_xmit</code>中挂接一个<code>tracepoint</code>钩子，在<code>dev_queue_xmit</code>/<code>eth_type_trans</code>/<code>napi_gro_receive</code>/<code>__netif_receive_skb_core</code>/<code>tcp_v4_rcv</code>等函数的入口处挂接一个kprobe钩子。</p>
<p>那么到底什么是tracepoint？kprobe又是什么？说它们之前不得不说一下ftrace。ftrace(function trace)是利用gcc 编译器在编译时在每个函数的入口地址放置一个 probe 点，这个 probe 点会调用一个 probe 函数，这样这个probe 函数会对每个执行的内核函数进行跟踪并打印日志到<code>ring buffer</code>中，而用户可以通过 debugfs 来访问<code>ring buffer</code>中的内容。</p>
<p><img src="http://ww1.sinaimg.cn/large/005NFTS2ly1gdiy3ytzn8j309z041gln.jpg" alt="1.png"></p>
<p>kprobe 是很早前就存在于内核中的一种动态 trace 工具。kprobe 本身利用了 int 3（在 x86 中）实现了 probe 点（对应图中的A）。使用 kprobe 需要用户自己实现 kernel module 来注册 probe 函数。kprobe 并没有统一的B、C 和 D。使用起来用户需要自己实现很多东西，不是很灵活。而在 <code>function trace</code> 出现后，kprobe 借用了它的一部分设计模式，实现了统一的 probe 函数（对应于图中的 B），并利用了 <code>function trace</code> 的环形缓存和用户接口部分，也就是 C 和 D 部分功能。</p>
<p>而tracepoint是静态的trace，说白了它就是内核开发人员提前设置好的跟踪点，也提供了管理桩函数的接口，它们已经编译进了内核，这样做既有优点也有缺点。优点是使用tracepoint的开销较小，并且它的API相对稳定；缺点也很明显，第一，默认的点明显不够多，可能覆盖不到你的需求；第二，你加一个点就需要重新编译内核，而kprobe不需要；第三，由于是静态的，不使用它也会造成开销（从内核文档可以看出这个问题已经被优化，现在基本忽略）。</p>
<p>实验代码中，挂接kprobe和tracepoint钩子的方法分别为<code>hook_kprobe</code>和<code>hook_tracepoint</code>，<code>hook_kprobe</code>代码如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">hook_kprobe</span>(<span style="color:#66d9ef">struct</span> kprobe <span style="color:#f92672">*</span>kp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name,
		kprobe_pre_handler_t pre, kprobe_post_handler_t post)
{
	kprobe_opcode_t <span style="color:#f92672">*</span>addr;

	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>name <span style="color:#f92672">||</span> strlen(name) <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">255</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;
	addr <span style="color:#f92672">=</span> (kprobe_opcode_t <span style="color:#f92672">*</span>)kallsyms_lookup_name(name);
	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>addr)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;

	memset(kp, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> kprobe));
	kp<span style="color:#f92672">-&gt;</span>symbol_name <span style="color:#f92672">=</span> name;
	kp<span style="color:#f92672">-&gt;</span>pre_handler <span style="color:#f92672">=</span> pre;
	kp<span style="color:#f92672">-&gt;</span>post_handler <span style="color:#f92672">=</span> post;

	register_kprobe(kp);

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>由于是动态追踪，需要先调用<code>kallsyms_lookup_name</code>检查是否有这个函数。如果有这个函数，那么就把kprobe的<code>pre_handler</code>和<code>post_handler</code>赋值给他，这两个都是钩子，会在其他地方定义好，它才是真正要干的事情，这是kprobe机制规定的，不用觉得奇怪。最后调用<code>register_kprobe</code>注册这个kprobe。</p>
<p><code>register_kprobe</code>函数非常复杂，我这里截取最为核心的部分：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">cpus_read_lock();
	<span style="color:#75715e">/* Prevent text modification */</span>
	mutex_lock(<span style="color:#f92672">&amp;</span>text_mutex);
	ret <span style="color:#f92672">=</span> prepare_kprobe(p);
	mutex_unlock(<span style="color:#f92672">&amp;</span>text_mutex);
	cpus_read_unlock();
	<span style="color:#66d9ef">if</span> (ret)
		<span style="color:#66d9ef">goto</span> out;

	INIT_HLIST_NODE(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>hlist);
	hlist_add_head_rcu(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>hlist,
		       <span style="color:#f92672">&amp;</span>kprobe_table[hash_ptr(p<span style="color:#f92672">-&gt;</span>addr, KPROBE_HASH_BITS)]);

	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>kprobes_all_disarmed <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>kprobe_disabled(p)) {
		ret <span style="color:#f92672">=</span> arm_kprobe(p);
		<span style="color:#66d9ef">if</span> (ret) {
			hlist_del_rcu(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>hlist);
			synchronize_rcu();
			<span style="color:#66d9ef">goto</span> out;
		}
	}
</code></pre></div><p><code>prepare_kprobe</code>保存当前的指令，<code>arm_kprobe</code>将当前指令替换为int3。然后就会执行<code>kprobe_int3_handler</code>，此时如果你的handler实现了并且注册了，那么就会执行你的handler了，这里应该就是“插桩”的本质了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">kprobe_int3_handler</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs)
{
	kprobe_opcode_t <span style="color:#f92672">*</span>addr;
	<span style="color:#66d9ef">struct</span> kprobe <span style="color:#f92672">*</span>p;
	<span style="color:#66d9ef">struct</span> kprobe_ctlblk <span style="color:#f92672">*</span>kcb;

	<span style="color:#66d9ef">if</span> (user_mode(regs))
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;

	addr <span style="color:#f92672">=</span> (kprobe_opcode_t <span style="color:#f92672">*</span>)(regs<span style="color:#f92672">-&gt;</span>ip <span style="color:#f92672">-</span> <span style="color:#66d9ef">sizeof</span>(kprobe_opcode_t));
	<span style="color:#75715e">/*
</span><span style="color:#75715e">	 * We don&#39;t want to be preempted for the entire duration of kprobe
</span><span style="color:#75715e">	 * processing. Since int3 and debug trap disables irqs and we clear
</span><span style="color:#75715e">	 * IF while singlestepping, it must be no preemptible.
</span><span style="color:#75715e">	 */</span>

	kcb <span style="color:#f92672">=</span> get_kprobe_ctlblk();
	p <span style="color:#f92672">=</span> get_kprobe(addr);

	<span style="color:#66d9ef">if</span> (p) {
		<span style="color:#66d9ef">if</span> (kprobe_running()) {
			<span style="color:#66d9ef">if</span> (reenter_kprobe(p, regs, kcb))
				<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
		} <span style="color:#66d9ef">else</span> {
			set_current_kprobe(p, regs, kcb);
			kcb<span style="color:#f92672">-&gt;</span>kprobe_status <span style="color:#f92672">=</span> KPROBE_HIT_ACTIVE;

			<span style="color:#75715e">/*
</span><span style="color:#75715e">			 * If we have no pre-handler or it returned 0, we
</span><span style="color:#75715e">			 * continue with normal processing.  If we have a
</span><span style="color:#75715e">			 * pre-handler and it returned non-zero, that means
</span><span style="color:#75715e">			 * user handler setup registers to exit to another
</span><span style="color:#75715e">			 * instruction, we must skip the single stepping.
</span><span style="color:#75715e">			 */</span>
			<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>p<span style="color:#f92672">-&gt;</span>pre_handler <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>p<span style="color:#f92672">-&gt;</span>pre_handler(p, regs))
				setup_singlestep(p, regs, kcb, <span style="color:#ae81ff">0</span>);
			<span style="color:#66d9ef">else</span>
				reset_current_kprobe();
			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
		}
	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>addr <span style="color:#f92672">!=</span> BREAKPOINT_INSTRUCTION) {...
</code></pre></div><p>在设置单步调试<code>setup_singlestep</code>时，还会把<code>post_handler</code>的地址设置为下一个执行指令，以便<code>pre_handler</code>返回时可以“reenter”到kprobe异常，顺利执行<code>post_handler</code>，最后才执行原本执行的代码，它存放在kprobe结构体中。虽然这个实验并没有实现<code>post_handler</code>，但机制就是这样的。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup_singlestep</span>(<span style="color:#66d9ef">struct</span> kprobe <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs,
			     <span style="color:#66d9ef">struct</span> kprobe_ctlblk <span style="color:#f92672">*</span>kcb, <span style="color:#66d9ef">int</span> reenter)
{
	<span style="color:#66d9ef">if</span> (setup_detour_execution(p, regs, reenter))
		<span style="color:#66d9ef">return</span>;

<span style="color:#75715e">#if !defined(CONFIG_PREEMPT)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>ainsn.boostable <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>p<span style="color:#f92672">-&gt;</span>post_handler) {
		<span style="color:#75715e">/* Boost up -- we can execute copied instructions directly */</span>
		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>reenter)
			reset_current_kprobe();
		<span style="color:#75715e">/*
</span><span style="color:#75715e">		 * Reentering boosted probe doesn&#39;t reset current_kprobe,
</span><span style="color:#75715e">		 * nor set current_kprobe, because it doesn&#39;t use single
</span><span style="color:#75715e">		 * stepping.
</span><span style="color:#75715e">		 */</span>
		regs<span style="color:#f92672">-&gt;</span>ip <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)p<span style="color:#f92672">-&gt;</span>ainsn.insn;
		<span style="color:#66d9ef">return</span>;
	}
<span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (reenter) {
		save_previous_kprobe(kcb);
		set_current_kprobe(p, regs, kcb);
		kcb<span style="color:#f92672">-&gt;</span>kprobe_status <span style="color:#f92672">=</span> KPROBE_REENTER;
	} <span style="color:#66d9ef">else</span>
		kcb<span style="color:#f92672">-&gt;</span>kprobe_status <span style="color:#f92672">=</span> KPROBE_HIT_SS;
	<span style="color:#75715e">/* Prepare real single stepping */</span>
	clear_btf();
	regs<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">|=</span> X86_EFLAGS_TF;
	regs<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>X86_EFLAGS_IF;
	<span style="color:#75715e">/* single step inline if the instruction is an int3 */</span>
	<span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>opcode <span style="color:#f92672">==</span> BREAKPOINT_INSTRUCTION)
		regs<span style="color:#f92672">-&gt;</span>ip <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)p<span style="color:#f92672">-&gt;</span>addr;
	<span style="color:#66d9ef">else</span>
		regs<span style="color:#f92672">-&gt;</span>ip <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)p<span style="color:#f92672">-&gt;</span>ainsn.insn;
}
NOKPROBE_SYMBOL(setup_singlestep);
</code></pre></div><p>Tracepoint相对简单一点，实验里直接调用了<code>tracepoint_probe_register</code>，就不展开说了，通常情况都是用<code>DECLARE_TRACE</code> 、<code> DEFINE_TRACE</code>这两个宏。可以阅读内核文档查阅一些高级的用法。</p>
<p>值得一提的是，实验代码为tracepoint设置了条件宏以便适应不同的内核版本，比较有意思，这里给出结构大家感受一下：</p>
<p><img src="http://ww1.sinaimg.cn/large/005NFTS2ly1gdj02e2t18j307f06dq48.jpg" alt="2.png"></p>

                        </div>
                        
                        

                    </div>
                    

                    

                    

                    <div class="col-md-3">

                        

                        







<div class="panel panel-default sidebar-menu">

    <div class="panel-heading">
        <h3 class="panel-title">分类</h3>
    </div>

    <div class="panel-body">
        <ul class="nav nav-pills nav-stacked">
            
            
            <li>
                <a href="/categories/linux%e5%86%85%e6%a0%b8%e8%af%95%e9%aa%8c">linux内核试验 (2)</a>
            </li>
            
        </ul>
    </div>

</div>









                        

                    </div>
                    

                    

                </div>
                

            </div>
            
        </div>
        

        <footer id="footer">
    <div class="container">

        
        <div class="col-md-4 col-sm-6">
            <h4>关于我们</h4>

            <p>请关注我们的微信公众号：Linux内核之旅</p> <br><p> <img src='http://ww1.sinaimg.cn/large/005NFTS2ly1gdomzdbh19j3094091myj.jpg' alt='Linux内核之旅微信公众号' width='128' height='128'></p>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

        <div class="col-md-4 col-sm-6">

             
            <h4>最新博客</h4>

            <div class="blog-entries">
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://example.org/blog/2020/04/10/tcp%E4%B8%A2%E5%8C%85%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%E8%A7%A3%E6%9E%90%E4%B8%80-proc%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">
                          
                            <img src="/img/banners/%e2%80%9ctcp%e4%b8%a2%e5%8c%85%e5%88%86%e6%9e%90%e2%80%9d%e5%ae%9e%e9%aa%8c%e8%a7%a3%e6%9e%90%28%e4%b8%80%29.png" class="img-responsive" alt="“tcp丢包分析”实验解析(一)--proc文件系统">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://example.org/blog/2020/04/10/tcp%E4%B8%A2%E5%8C%85%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%E8%A7%A3%E6%9E%90%E4%B8%80-proc%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">“tcp丢包分析”实验解析(一)--proc文件系统</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://example.org/blog/2020/04/10/tcp%E4%B8%A2%E5%8C%85%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%E8%A7%A3%E6%9E%90%E4%BA%8C-kprobe%E5%92%8Ctracepoint/">
                          
                            <img src="/img/banners/%e2%80%9ctcp%e4%b8%a2%e5%8c%85%e5%88%86%e6%9e%90%e2%80%9d%e5%ae%9e%e9%aa%8c%e8%a7%a3%e6%9e%90%28%e4%ba%8c%29.png" class="img-responsive" alt="“tcp丢包分析”实验解析(二)--kprobe和tracepoint">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://example.org/blog/2020/04/10/tcp%E4%B8%A2%E5%8C%85%E5%88%86%E6%9E%90%E5%AE%9E%E9%AA%8C%E8%A7%A3%E6%9E%90%E4%BA%8C-kprobe%E5%92%8Ctracepoint/">“tcp丢包分析”实验解析(二)--kprobe和tracepoint</a></h5>
                    </div>
                </div>
                
            </div>

            <hr class="hidden-md hidden-lg">
             

        </div>
        

        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-left">Copyright (c), linuxkerneltravel, all rights reserved.</p>
            
            <p class="pull-right">
              模板来自 <a href="https://bootstrapious.com/p/universal-business-e-commerce-template">Bootstrapious</a>.
              

              移植到 Hugo 来自 <a href="https://github.com/devcows/hugo-universal-theme">DevCows</a>.
            </p>
        </div>
    </div>
</div>





    </div>
    

    
<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>

<script src="//maps.googleapis.com/maps/api/js?key=AIzaSyCFhtWLJcE30xOAjcbSFi-0fnoVmQZPb1Y&v=3.exp"></script>

<script src="/js/hpneo.gmaps.js"></script>
<script src="/js/gmaps.init.js"></script>
<script src="/js/front.js"></script>


<script src="/js/owl.carousel.min.js"></script>



  </body>
</html>
